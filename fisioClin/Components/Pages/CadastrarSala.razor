@page "/cadastrarsala"
@using fisioClin.Models
@using fisioClin.Configs
@inject Conexao Conexao
@inject NavigationManager NavManager

<h2 class="mb-4">Cadastrar Salas</h2>

<div class="container container-custom">
    <EditForm Model="@sala" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Nº da sala -->
        <div class="mb-3">
            <label class="form-label">Nº da sala</label>
            <InputText class="form-control" @bind-Value="sala.Numero" />
        </div>

        <!-- Linha 1 -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label">Capacidade</label>
                <InputText class="form-control" @bind-Value="sala.Capacidade" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Tipo de sala</label>
                <InputSelect class="form-select" @bind-Value="sala.Tipo">
                    <option disabled selected value="">Selecione</option>
                    <option value="Sala de aula">Sala de aula</option>
                    <option value="Laboratório">Laboratório</option>
                    <option value="Auditório">Auditório</option>
                </InputSelect>
            </div>
        </div>

        <!-- Linha 2 -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label">Disponibilidade</label>
                <InputText class="form-control" @bind-Value="sala.Disponibilidade" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Observações</label>
                <InputText class="form-control" @bind-Value="sala.Observacao" />
            </div>
        </div>

        <!-- Botões -->
        <div class="d-flex justify-content-end d-flex-gap mt-4">
            <button type="submit" class="btn btn-cadastrar">Cadastrar</button>
            <a href="/consultarsala" class="btn btn-alterar">Ver Salas</a>
        </div>
    </EditForm>

    @if (!string.IsNullOrEmpty(mensagemSucesso))
    {
        <div class="alert alert-success mt-3">@mensagemSucesso</div>
    }
    @if (!string.IsNullOrEmpty(mensagemErro))
    {
        <div class="alert alert-danger mt-3">@mensagemErro</div>
    }
</div>

@code {
    private Sala sala = new Sala();
    private string? mensagemSucesso;
    private string? mensagemErro;

    private void HandleValidSubmit()
    {
        try
        {
            var dao = new SalaDAO(Conexao);

            // Define ID como 0 ou null, assumindo que o banco faz auto-increment
            sala.Id = 0;

            dao.Inserir(sala);

            mensagemSucesso = "Sala cadastrada com sucesso!";
            mensagemErro = null;

            // Redirecionar para consultar salas após 1 segundo
            Task.Delay(1000).ContinueWith(_ =>
            {
                NavManager.NavigateTo("/consultarsala", forceLoad: true);
            });
        }
        catch (Exception ex)
        {
            mensagemErro = "Erro ao cadastrar sala: " + ex.Message;
            mensagemSucesso = null;
        }
    }
}
