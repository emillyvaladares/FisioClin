@page "/cadastrarfuncionario"
@page "/cadastrarfuncionario/{id:int}"

@using fisioClin.Models
@inject FuncionariosDAO funcionarioDAO
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations

@rendermode InteractiveServer

<main class="container my-4">

    <h2 class="text-maroon mb-4">
        @(id == null ? "Cadastrar Funcionário" : "Editar Funcionário")
    </h2>

    <section class="position-relative p-4 bg-white rounded shadow-sm">

        <EditForm Model="_novoFuncionario" OnValidSubmit="SalvarFuncionario">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-3">

                <div class="col-12 mb-3 position-relative">
                    <label class="form-label">Nome completo</label>
                    <InputText class="form-control" @bind-Value="_novoFuncionario.Nome" />
                    <ValidationMessage For="@(() => _novoFuncionario.Nome)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">CPF</label>
                    <InputCpf class="form-control" @bind-Value="_novoFuncionario.Cpf" />
                    <ValidationMessage For="@(() => _novoFuncionario.Cpf)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">RG</label>
                    <InputText class="form-control" @bind-Value="_novoFuncionario.Rg" />
                    <ValidationMessage For="@(() => _novoFuncionario.Rg)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Tipo de vínculo</label>
                    <InputSelect class="form-select" @bind-Value="_novoFuncionario.TipoVinculo">
                        <option value="">Selecione</option>
                        <option>CLT</option>
                        <option>PJ</option>
                        <option>Estágio</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => _novoFuncionario.TipoVinculo)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Telefone</label>
                    <InputTelefone class="form-control" @bind-Value="_novoFuncionario.Telefone" />
                    <ValidationMessage For="@(() => _novoFuncionario.Telefone)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Email</label>
                    <InputText type="email" class="form-control" @bind-Value="_novoFuncionario.Email" />
                    <ValidationMessage For="@(() => _novoFuncionario.Email)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Registro</label>
                    <InputText class="form-control" @bind-Value="_novoFuncionario.Registro" />
                    <ValidationMessage For="@(() => _novoFuncionario.Registro)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Especialidade</label>
                    <InputText class="form-control" @bind-Value="_novoFuncionario.Especialidade" />
                    <ValidationMessage For="@(() => _novoFuncionario.Especialidade)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Subespecialidade</label>
                    <InputText class="form-control" @bind-Value="_novoFuncionario.Subespecialidade" />
                    <ValidationMessage For="@(() => _novoFuncionario.Subespecialidade)" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">Certificados</label>
                    <InputText class="form-control" @bind-Value="_novoFuncionario.Certificados" />
                    <ValidationMessage For="@(() => _novoFuncionario.Certificados)" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Data de Nascimento</label>
                    <InputDate class="form-control" @bind-Value="_novoFuncionario.DataNascimento" />
                    <ValidationMessage For="@(() => _novoFuncionario.DataNascimento)" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Data de contratação</label>
                    <InputDate class="form-control" @bind-Value="_novoFuncionario.DataContratacao" />
                    <ValidationMessage For="@(() => _novoFuncionario.DataContratacao)" />
                </div>

            </div>

            <div class="mt-4 d-flex gap-3">
                <button type="submit" class="btn btn-maroon">
                    @(id == null ? "Cadastrar" : "Atualizar")
                </button>

                @if (id == null)
                {
                    <button type="reset" class="btn btn-secondary">Limpar</button>
                }
            </div>

        </EditForm>
    </section>

    <ModalSucesso @ref="_modal" Mensagem="Funcionário salvo com sucesso!" />
</main>

@code {

    [Parameter] public int? id { get; set; }

    private Funcionarios _novoFuncionario = new();
    private ModalSucesso _modal;

    protected override void OnParametersSet()
    {
        // AGORA FUNCIONA! — Carrega o funcionário sempre que o ID muda.
        if (id != null && id > 0)
        {
            _novoFuncionario = funcionarioDAO.BuscarPorId(id.Value) ?? new Funcionarios();
        }
    }

    private async Task SalvarFuncionario()
    {
        try
        {
            if (!string.IsNullOrWhiteSpace(_novoFuncionario.Cpf))
                _novoFuncionario.Cpf = new string(_novoFuncionario.Cpf.Where(char.IsDigit).ToArray());

            if (id == null)
                funcionarioDAO.Inserir(_novoFuncionario);
            else
                funcionarioDAO.Atualizar(_novoFuncionario);

            _modal.Mostrar();
            await Task.Delay(2000);
            _modal.Fechar();

            Nav.NavigateTo("/consultarfuncionarios", true); // força reload da página

        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }
}
