@page "/cadastrar_agenda"
@using fisioClin.Models
@inject AgendaDAO agendaDAO
@inject SalaDAO salaDAO
@inject FuncionariosDAO funcionariosDAO
@inject PacienteDAO pacienteDAO
@inject TipoDAO tipoDAO
@inject NavigationManager nav

@rendermode InteractiveServer

<main class="container my-4">

    <h2 class="text-maroon mb-4">Cadastrar Agenda</h2>

    <section class="position-relative p-4 bg-white rounded shadow-sm">
        <EditForm Model="_agenda" OnValidSubmit="Salvar" FormName="CadastrarAgendaForm">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-3">

                <!-- DATA -->
                <div class="col-md-4">
                    <label class="form-label">Data</label>
                    <InputDate class="form-control" @bind-Value="_agenda.Data" />
                    <ValidationMessage For="@(() => _agenda.Data)" />
                </div>

                <!-- HORÁRIO -->
                <div class="col-md-4">
                    <label class="form-label">Horário</label>
                    <InputText class="form-control" type="time" @bind-Value="_agenda.Horario" />
                    <ValidationMessage For="@(() => _agenda.Horario)" />
                </div>

                <!-- SALA -->
                <div class="col-md-4">
                    <label class="form-label">Sala</label>
                    <InputSelect class="form-select" @bind-Value="_agenda.Id_Sala_fk">
                        <option value="">Selecione</option>
                        @foreach (var s in Salas)
                        {
                            <option value="@s.Id">@s.Nome</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => _agenda.Id_Sala_fk)" />
                </div>

                <!-- FUNCIONÁRIO -->
                <div class="col-md-4">
                    <label class="form-label">Funcionário</label>
                    <InputSelect class="form-select" @bind-Value="_agenda.Id_Funcionario_fk">
                        <option value="">Selecione</option>
                        @foreach (var f in Funcionarios)
                        {
                            <option value="@f.Id">@f.Nome</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => _agenda.Id_Funcionario_fk)" />
                </div>

                <!-- PACIENTE -->
                <div class="col-md-4">
                    <label class="form-label">Paciente</label>
                    <InputSelect class="form-select" @bind-Value="_agenda.Id_Paciente_fk">
                        <option value="">Selecione</option>
                        @foreach (var p in Pacientes)
                        {
                            <option value="@p.Id">@p.Nome</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => _agenda.Id_Paciente_fk)" />
                </div>

                <!-- TIPO DE CONSULTA -->
                <div class="col-md-4">
                    <label class="form-label">Tipo de Consulta</label>
                    <InputSelect class="form-select" @bind-Value="_agenda.Id_Tipo_fk">
                        <option value="">Selecione</option>
                        @foreach (var t in Tipos)
                        {
                            <option value="@t.Id">@t.Nome</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => _agenda.Id_Tipo_fk)" />
                </div>

                <!-- OBSERVAÇÃO -->
                <div class="col-12">
                    <label class="form-label">Observação</label>
                    <InputTextArea class="form-control" @bind-Value="_agenda.Observacao" />
                </div>

            </div>

            <div class="mt-4 d-flex gap-3">
                <button type="submit" class="btn btn-maroon">Cadastrar</button>
                <button type="reset" class="btn btn-secondary">Limpar</button>
            </div>

        </EditForm>
    </section>

    <ModalSucesso @ref="_modal" Mensagem="Agenda cadastrada com sucesso!" />

</main>

@code {
    private Agenda _agenda = new();
    private ModalSucesso _modal;

    // Listas carregadas no OnInitialized
    private List<Sala> Salas = new();
    private List<Funcionarios> Funcionarios = new();
    private List<Paciente> Pacientes = new();
    private List<Tipo> Tipos = new();

    protected override void OnInitialized()
    {
        Salas = salaDAO.ListarTodos();
        Funcionarios = funcionariosDAO.ListarTodos();
        Pacientes = pacienteDAO.ListarTodos();
        Tipos = tipoDAO.ListarTodos();
    }

    private async Task Salvar()
    {
        try
        {
            agendaDAO.Inserir(_agenda);

            _modal.Mensagem = "Agenda cadastrada com sucesso!";
            _modal.Mostrar();

            await Task.Delay(2000);
            _modal.Fechar();
            nav.NavigateTo("/visualizaragenda");
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }
}

<style>
    .text-maroon {
        color: #6b0010;
    }

    .btn-maroon {
        background-color: #8b0015;
        color: white;
        border: none;
    }

        .btn-maroon:hover {
            background-color: #a3001c;
        }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
</style>
